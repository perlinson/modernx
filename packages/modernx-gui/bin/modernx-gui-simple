#!/usr/bin/env node

/**
 * ModernX GUI æç®€æ¼”ç¤ºç‰ˆæœ¬
 */

const http = require('http');
const fs = require('fs');
const path = require('path');

// ç®€å•çš„é¡¹ç›®æ£€æµ‹
async function detectProject(projectPath) {
  const packageJsonPath = path.join(projectPath, 'package.json');
  const modelsPath = path.join(projectPath, 'src/models');
  
  let isModernX = false;
  let packageInfo = {};
  
  if (fs.existsSync(packageJsonPath)) {
    try {
      const packageContent = fs.readFileSync(packageJsonPath, 'utf8');
      packageInfo = JSON.parse(packageContent);
      
      if (packageInfo.dependencies && packageInfo.dependencies.modernx) {
        isModernX = true;
      }
    } catch (error) {
      console.warn('Could not read package.json:', error.message);
    }
  }
  
  let models = [];
  if (fs.existsSync(modelsPath)) {
    try {
      const modelFiles = fs.readdirSync(modelsPath);
      models = modelFiles.filter(file => file.endsWith('.js'));
    } catch (error) {
      console.warn('Could not scan models directory:', error.message);
    }
  }
  
  return {
    name: packageInfo.name || path.basename(projectPath),
    path: projectPath,
    isModernX,
    models,
    packageInfo,
  };
}

// åˆ›å»º HTML å†…å®¹
function createGUIHTML(projectInfo) {
  var projectName = projectInfo.name || 'æœªçŸ¥';
  var projectPath = projectInfo.path || 'æœªçŸ¥';
  var isModernX = projectInfo.isModernX ? 'âœ… æ˜¯' : 'âŒ å¦';
  
  var modelsList = '<li>æš‚æ— æ¨¡å‹æ–‡ä»¶</li>';
  if (projectInfo.models && projectInfo.models.length > 0) {
    modelsList = projectInfo.models.map(function(model) {
      return '<li>' + model + '</li>';
    }).join('');
  }
  
  var html = '<!DOCTYPE html><html lang="zh-CN"><head>';
  html += '<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">';
  html += '<title>ModernX GUI - æ¼”ç¤ºç‰ˆ</title>';
  html += '<style>';
  html += 'body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }';
  html += '.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }';
  html += '.container { max-width: 1200px; margin: 0 auto; }';
  html += '.grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }';
  html += '.sidebar, .main-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }';
  html += '.card { margin-bottom: 20px; }';
  html += '.state-display { background: #1e293b; color: #10b981; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }';
  html += '.action-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 15px; margin-bottom: 10px; }';
  html += '.action-type { font-weight: bold; color: #667eea; }';
  html += '.action-time { font-size: 0.8rem; color: #64748b; margin-left: 10px; }';
  html += '.action-payload { background: #1e293b; color: #e2e8f0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; margin-top: 10px; white-space: pre-wrap; }';
  html += '.btn { background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }';
  html += '.btn:hover { background: #5a67d8; }';
  html += '.btn-secondary { background: #64748b; }';
  html += '.btn-secondary:hover { background: #475569; }';
  html += '.project-info { background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px; padding: 15px; margin-bottom: 15px; }';
  html += '.models-list ul { list-style: none; padding: 0; }';
  html += '.models-list li { background: #f1f5f9; padding: 10px; border-radius: 4px; margin-bottom: 5px; }';
  html += '</style></head><body>';
  
  html += '<div class="container">';
  html += '<div class="header"><h1>ğŸ¨ ModernX GUI</h1><p>å®æ—¶çŠ¶æ€ç›‘æ§å’Œè°ƒè¯•å·¥å…· - æ¼”ç¤ºç‰ˆæœ¬</p></div>';
  
  html += '<div class="grid">';
  html += '<div class="sidebar">';
  html += '<div class="project-info"><h4>ğŸ“ é¡¹ç›®ä¿¡æ¯</h4>';
  html += '<p><strong>åç§°:</strong> ' + projectName + '</p>';
  html += '<p><strong>è·¯å¾„:</strong> ' + projectPath + '</p>';
  html += '<p><strong>ModernX:</strong> ' + isModernX + '</p></div>';
  
  html += '<div class="card"><h3>ğŸ“Š æ¨¡å‹åˆ—è¡¨</h3>';
  html += '<div class="models-list"><ul>' + modelsList + '</ul></div></div>';
  html += '</div>';
  
  html += '<div class="main-content">';
  html += '<div class="card"><h3>ğŸ® æ¼”ç¤ºæ§åˆ¶</h3>';
  html += '<button class="btn" onclick="simulateLogin()">æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•</button>';
  html += '<button class="btn" onclick="simulateIncrement()">è®¡æ•°å™¨ +1</button>';
  html += '<button class="btn" onclick="simulateDecrement()">è®¡æ•°å™¨ -1</button>';
  html += '<button class="btn btn-secondary" onclick="resetState()">é‡ç½®çŠ¶æ€</button>';
  html += '<button class="btn btn-secondary" onclick="clearHistory()">æ¸…ç©ºå†å²</button></div>';
  
  html += '<div class="card"><h3>ğŸ”„ å½“å‰çŠ¶æ€</h3>';
  html += '<div class="state-display" id="state-display">{\n  "user": {\n    "currentUser": null,\n    "loading": false,\n    "error": null\n  },\n  "counter": {\n    "count": 0,\n    "history": []\n  }\n}</div></div>';
  
  html += '<div class="card"><h3>âš¡ åŠ¨ä½œå†å²</h3>';
  html += '<div id="actions-history"><div class="action-item">';
  html += '<span class="action-type">ç­‰å¾…åŠ¨ä½œ...</span>';
  html += '<span class="action-time">--:--:--</span>';
  html += '<div class="action-payload">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ¼”ç¤º</div></div></div></div>';
  html += '</div></div></div>';
  
  html += '<script>';
  html += 'var currentState = {user: {currentUser: null, loading: false, error: null}, counter: {count: 0, history: []}};';
  html += 'var actions = [];var actionId = 0;';
  html += 'function updateStateDisplay() {document.getElementById("state-display").textContent = JSON.stringify(currentState, null, 2);}';
  html += 'function addAction(type, payload) {var action = {id: ++actionId, type: type, payload: payload, timestamp: Date.now()};';
  html += 'actions.unshift(action);if (actions.length > 20) actions.pop();';
  html += 'var historyContainer = document.getElementById("actions-history");var html = "";';
  html += 'for (var i = 0; i < actions.length; i++) {var action = actions[i];';
  html += 'html += "<div class=\\"action-item\\">";';
  html += 'html += "<span class=\\"action-type\\">" + action.type + "</span>";';
  html += 'html += "<span class=\\"action-time\\">" + new Date(action.timestamp).toLocaleTimeString() + "</span>";';
  html += 'html += "<div class=\\"action-payload\\">" + JSON.stringify(action.payload, null, 2) + "</div></div>";}';
  html += 'historyContainer.innerHTML = html;}';
  html += 'function simulateLogin() {currentState.user.loading = true;updateStateDisplay();addAction("user/login", {username: "alice"});';
  html += 'setTimeout(function() {currentState.user = {currentUser: {id: 1, name: "Alice", email: "alice@example.com"}, loading: false, error: null};updateStateDisplay();addAction("user/setUser", currentState.user.currentUser);}, 1000);}';
  html += 'function simulateIncrement() {currentState.counter.count++;updateStateDisplay();addAction("counter/increment", {amount: 1});}';
  html += 'function simulateDecrement() {currentState.counter.count--;updateStateDisplay();addAction("counter/decrement", {amount: 1});}';
  html += 'function resetState() {currentState = {user: {currentUser: null, loading: false, error: null}, counter: {count: 0, history: []}};updateStateDisplay();addAction("app/reset", {});}';
  html += 'function clearHistory() {actions = [];document.getElementById("actions-history").innerHTML = "<div class=\\"action-item\\"><span class=\\"action-type\\">å†å²å·²æ¸…ç©º</span></div>";}';
  html += 'document.addEventListener("DOMContentLoaded", function() {updateStateDisplay();});';
  html += '</script></body></html>';
  
  return html;
}

// åˆ›å»º HTTP æœåŠ¡å™¨
async function startServer() {
  var port = 3001;
  
  // æ£€æµ‹é¡¹ç›®ä¿¡æ¯
  var projectInfo = await detectProject(process.cwd());
  
  var server = http.createServer(function(req, res) {
    if (req.url === '/' || req.url === '/index.html') {
      res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
      res.end(createGUIHTML(projectInfo));
    } else if (req.url === '/api/project') {
      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify(projectInfo));
    } else {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      res.end('Not Found');
    }
  });
  
  server.listen(port, function() {
    console.log('ğŸš€ ModernX GUI æ¼”ç¤ºç‰ˆå·²å¯åŠ¨!');
    console.log('ğŸŒ è¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—®: http://localhost:' + port);
    console.log('');
    console.log('ğŸ“‹ é¡¹ç›®ä¿¡æ¯:');
    console.log('  - é¡¹ç›®åç§°: ' + projectInfo.name);
    console.log('  - ModernX é¡¹ç›®: ' + (projectInfo.isModernX ? 'âœ… æ˜¯' : 'âŒ å¦'));
    console.log('  - æ¨¡å‹æ–‡ä»¶: ' + projectInfo.models.length + ' ä¸ª');
    console.log('');
    console.log('ğŸ¯ åŠŸèƒ½æ¼”ç¤º:');
    console.log('  - ç‚¹å‡»æŒ‰é’®æ¨¡æ‹ŸçŠ¶æ€æ›´æ–°');
    console.log('  - æŸ¥çœ‹å®æ—¶çŠ¶æ€å˜åŒ–');
    console.log('  - è¿½è¸ªåŠ¨ä½œå†å²è®°å½•');
    console.log('');
    console.log('ğŸ’¡ è¿™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼Œå®Œæ•´åŠŸèƒ½éœ€è¦æ„å»ºåä½¿ç”¨');
  });
  
  return server;
}

// ä¸»å‡½æ•°
async function main() {
  try {
    await startServer();
  } catch (error) {
    console.error('âŒ å¯åŠ¨å¤±è´¥:', error.message);
    process.exit(1);
  }
}

main();