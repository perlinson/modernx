#!/usr/bin/env node

/**
 * ModernX GUI å¼€å‘ç‰ˆæœ¬å¯åŠ¨è„šæœ¬
 * ç›´æ¥ä½¿ç”¨æºä»£ç ï¼Œæ— éœ€æ„å»º
 */

const express = require('express');
const WebSocket = require('ws');
const path = require('path');
const fs = require('fs');

// ç›´æ¥å¯¼å…¥æºä»£ç æ¨¡å—
const { detectProject } = require('./src/lib/project-detector.js');

async function openBrowser(url) {
  try {
    const { execSync } = require('child_process');
    const platform = process.platform;
    
    if (platform === 'darwin') {
      execSync(`open "${url}"`);
    } else if (platform === 'win32') {
      execSync(`start "${url}"`);
    } else {
      execSync(`xdg-open "${url}"`);
    }
    
    console.log(`ğŸŒ å·²åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€: ${url}`);
  } catch (error) {
    console.warn('æ— æ³•è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨:', error.message);
    console.log(`è¯·æ‰‹åŠ¨è®¿é—®: ${url}`);
  }
}

async function startServer(options = {}) {
  const app = express();
  const port = options.port || 3000;
  
  // åˆ›å»ºä¸€ä¸ªç®€å•çš„ HTML ç•Œé¢ï¼ˆå› ä¸ºè¿˜æ²¡æœ‰æ„å»ºå‰ç«¯ï¼‰
  app.get('/', (req, res) => {
    const html = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModernX GUI - å¼€å‘ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .header { background: #2563eb; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        .status { display: flex; align-items: center; gap: 0.5rem; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #10b981; }
        .container { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 60px); }
        .sidebar { background: white; border-right: 1px solid #e5e7eb; padding: 1rem; overflow-y: auto; }
        .main-content { padding: 1rem; overflow-y: auto; }
        .card { background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 0.5rem; color: #374151; }
        .state-display { background: #1f2937; color: #10b981; padding: 1rem; border-radius: 4px; font-family: 'Monaco', 'Consolas', monospace; font-size: 0.875rem; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .action-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem; }
        .action-type { font-weight: 600; color: #2563eb; }
        .action-time { font-size: 0.75rem; color: #6b7280; margin-left: 0.5rem; }
        .action-payload { background: #1f2937; color: #f3f4f6; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.75rem; margin-top: 0.5rem; white-space: pre-wrap; }
        .models-list ul { list-style: none; }
        .models-list li { background: #f3f4f6; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.25rem; }
        .connection-status { display: flex; align-items: center; gap: 0.5rem; }
        .connected { color: #10b981; }
        .disconnected { color: #ef4444; }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ¨ ModernX GUI</h1>
        <div class="connection-status">
            <div class="status-dot"></div>
            <span id="connection-status">è¿æ¥ä¸­...</span>
        </div>
    </header>
    
    <div class="container">
        <aside class="sidebar">
            <div class="card">
                <h3>ğŸ“ é¡¹ç›®ä¿¡æ¯</h3>
                <div id="project-info">
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“Š æ¨¡å‹åˆ—è¡¨</h3>
                <div class="models-list">
                    <ul id="models-list">
                        <li>åŠ è½½ä¸­...</li>
                    </ul>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="card">
                <h3>ğŸ”„ å½“å‰çŠ¶æ€</h3>
                <div class="state-display" id="state-display">
{
  "user": {
    "currentUser": null,
    "loading": false,
    "error": null
  },
  "counter": {
    "count": 0,
    "history": []
  }
}
                </div>
            </div>
            
            <div class="card">
                <h3>âš¡ åŠ¨ä½œå†å²</h3>
                <div id="actions-history">
                    <div class="action-item">
                        <div>
                            <span class="action-type">ç­‰å¾…åŠ¨ä½œ...</span>
                            <span class="action-time">--:--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let ws;
        let actions = [];
        
        // è¿æ¥ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(\`\${protocol}//\${window.location.host}\`);
            
            ws.onopen = () => {
                console.log('Connected to ModernX GUI');
                document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                document.querySelector('.status-dot').style.background = '#10b981';
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'state_update') {
                        document.getElementById('state-display').textContent = JSON.stringify(data.payload, null, 2);
                    } else if (data.type === 'action') {
                        addActionToHistory(data.payload);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('Disconnected from ModernX GUI');
                document.getElementById('connection-status').textContent = 'è¿æ¥æ–­å¼€';
                document.querySelector('.status-dot').style.background = '#ef4444';
                // å°è¯•é‡è¿
                setTimeout(connectWebSocket, 2000);
            };
        }
        
        // æ·»åŠ åŠ¨ä½œåˆ°å†å²è®°å½•
        function addActionToHistory(action) {
            actions.unshift(action);
            if (actions.length > 50) actions.pop(); // åªä¿ç•™æœ€è¿‘50æ¡
            
            const historyContainer = document.getElementById('actions-history');
            historyContainer.innerHTML = actions.map(action => \`
                <div class="action-item">
                    <div>
                        <span class="action-type">\${action.type}</span>
                        <span class="action-time">\${new Date(action.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="action-payload">\${JSON.stringify(action.payload, null, 2)}</div>
                </div>
            \`).join('');
        }
        
        // åŠ è½½é¡¹ç›®ä¿¡æ¯
        async function loadProjectInfo() {
            try {
                const response = await fetch('/api/project');
                const projectInfo = await response.json();
                
                document.getElementById('project-info').innerHTML = \`
                    <p><strong>é¡¹ç›®åç§°:</strong> \${projectInfo.name || 'æœªçŸ¥'}</p>
                    <p><strong>é¡¹ç›®è·¯å¾„:</strong> \${projectInfo.path || 'æœªçŸ¥'}</p>
                    <p><strong>ModernX é¡¹ç›®:</strong> \${projectInfo.isModernX ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                \`;
                
                const modelsList = document.getElementById('models-list');
                if (projectInfo.models && projectInfo.models.length > 0) {
                    modelsList.innerHTML = projectInfo.models.map(model => 
                        \`<li>\${model}</li>\`
                    ).join('');
                } else {
                    modelsList.innerHTML = '<li>æš‚æ— æ¨¡å‹æ–‡ä»¶</li>';
                }
            } catch (error) {
                console.error('Failed to load project info:', error);
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            loadProjectInfo();
        });
    </script>
</body>
</html>`;
    res.send(html);
  });
  
  // API endpoint for project info
  app.get('/api/project', (req, res) => {
    res.json(options.projectInfo || {});
  });
  
  // WebSocket server for real-time communication
  const server = app.listen(port, () => {
    console.log(`ğŸš€ ModernX GUI æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${port}`);
  });
  
  const wss = new WebSocket.Server({ server });
  
  // Handle WebSocket connections
  wss.on('connection', (ws) => {
    console.log('ğŸ“¡ å®¢æˆ·ç«¯è¿æ¥åˆ° GUI');
    
    ws.on('message', (message) => {
      try {
        const data = JSON.parse(message);
        console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', data);
        
        // Broadcast to all clients
        wss.clients.forEach((client) => {
          if (client.readyState === WebSocket.OPEN) {
            client.send(JSON.stringify(data));
          }
        });
      } catch (error) {
        console.error('âŒ å¤„ç†æ¶ˆæ¯é”™è¯¯:', error);
      }
    });
    
    ws.on('close', () => {
      console.log('ğŸ“¡ å®¢æˆ·ç«¯æ–­å¼€è¿æ¥');
    });
  });
  
  return {
    server,
    wss,
    url: `http://localhost:${port}`,
    port,
  };
}

async function main() {
  try {
    console.log('ğŸš€ å¯åŠ¨ ModernX GUI (å¼€å‘ç‰ˆ)...');
    
    // æ£€æµ‹å½“å‰é¡¹ç›®ç»“æ„
    const projectInfo = await detectProject(process.cwd());
    console.log('ğŸ“ é¡¹ç›®æ£€æµ‹å®Œæˆ:', projectInfo.name);
    
    // å¯åŠ¨å¼€å‘æœåŠ¡å™¨
    const server = await startServer({
      port: 3000,
      projectInfo,
    });
    
    console.log(`ğŸŒ GUI æœåŠ¡å™¨åœ°å€: ${server.url}`);
    
    // è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    await openBrowser(server.url);
    console.log('âœ… ModernX GUI å·²å°±ç»ª!');
    console.log('');
    console.log('ğŸ’¡ æç¤º:');
    console.log('  - è¿™æ˜¯ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸´æ—¶ç•Œé¢');
    console.log('  - å®Œæ•´åŠŸèƒ½éœ€è¦æ„å»ºå‰ç«¯ä»£ç ');
    console.log('  - å¯ä»¥æ‰‹åŠ¨å‘é€çŠ¶æ€æ›´æ–°è¿›è¡Œæµ‹è¯•');
    console.log('');
    console.log('ğŸ”§ æµ‹è¯•å‘½ä»¤:');
    console.log('  curl -X POST http://localhost:3000/api/test -d \'{"type":"state_update","payload":{"test":"hello"}}\'');
    
    // æ·»åŠ æµ‹è¯•ç«¯ç‚¹
    server.server.on('request', (req, res) => {
      if (req.method === 'POST' && req.url === '/api/test') {
        let body = '';
        req.on('data', chunk => body += chunk);
        req.on('end', () => {
          try {
            const data = JSON.parse(body);
            server.wss.clients.forEach(client => {
              if (client.readyState === WebSocket.OPEN) {
                client.send(JSON.stringify(data));
              }
            });
            res.writeHead(200, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ success: true, message: 'æ•°æ®å·²å¹¿æ’­' }));
          } catch (error) {
            res.writeHead(400, { 'Content-Type': 'application/json' });
            res.end(JSON.stringify({ error: 'Invalid JSON' }));
          }
        });
      }
    });
    
  } catch (error) {
    console.error('âŒ å¯åŠ¨ ModernX GUI å¤±è´¥:', error.message);
    process.exit(1);
  }
}

main();
