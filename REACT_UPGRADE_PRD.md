# modernx 项目 React 版本升级 PRD 需求计划书

## 项目概述

**项目名称**: modernx React 框架升级  
**当前版本**: 3.0.0-alpha.1  
**目标**: 升级到适配最新 React 版本 (React 18+)  
**要求**: 保持 API 不变，确保向后兼容

## 当前项目状态分析

### 技术栈现状
- **React**: 已支持 React 18+ (peerDependencies: ">=18")
- **React DOM**: 已支持 React 18+ (peerDependencies: ">=18") 
- **React Redux**: ^7.1.0
- **React Router DOM**: ^5.1.2
- **Connected React Router**: 6.5.2
- **Redux**: ^4.0.1
- **Redux Saga**: ^0.16.0
- **History**: ^4.7.2

### 已完成的 React 18 适配
项目已经部分完成了 React 18 的适配工作：

1. **新的 ReactDOM API**: 在 `packages/modernx/src/index.js` 第102行已使用新的 `react-dom/client` API
```javascript
const ReactDOM = require('react-dom/client');
ReactDOM.createRoot(container).render(React.createElement(getProvider(store, app, router)));
```

2. **Peer Dependencies**: 已正确设置 React 18+ 的版本要求

## 升级目标与范围

### 主要目标
1. **完全兼容 React 18+**: 确保所有功能在 React 18+ 环境下正常工作
2. **保持 API 不变**: 现有 modernx 的 API 接口保持完全兼容
3. **性能优化**: 利用 React 18 的新特性提升性能
4. **现代化工具链**: 升级相关依赖到最新稳定版本

### 升级范围
- [x] React 18 基础兼容性 (已完成)
- [ ] React 18 新特性支持
- [ ] 依赖包现代化升级
- [ ] 测试框架升级
- [ ] 构建工具升级
- [ ] 文档更新

## 详细升级计划

### 阶段一: React 18 新特性支持 (预计 3-5 天)

#### 1.1 Concurrent Features 支持
- **目标**: 支持 React 18 的并发特性
- **工作内容**:
  - 测试 `useTransition` Hook 在 modernx 应用中的兼容性
  - 测试 `useDeferredValue` Hook 的兼容性
  - 确保 modernx 的状态管理与 React 18 并发模式兼容

#### 1.2 Strict Mode 兼容性
- **目标**: 确保在 React Strict Mode 下正常工作
- **工作内容**:
  - 修复可能的 Strict Mode 警告
  - 确保副作用清理函数正确实现
  - 验证 useEffect 的依赖数组正确性

#### 1.3 自动批处理优化
- **目标**: 利用 React 18 的自动批处理提升性能
- **工作内容**:
  - 测试 modernx 的状态更新在自动批处理下的行为
  - 优化不必要的重渲染
  - 确保 Redux 状态更新与 React 18 批处理兼容

### 阶段二: 依赖包现代化升级 (预计 2-3 天)

#### 2.1 React 生态系统升级
| 包名 | 当前版本 | 目标版本 | 说明 |
|------|----------|----------|------|
| react-redux | ^7.1.0 | ^8.1.0+ | 支持 React 18 新特性 |
| react-router-dom | ^5.1.2 | ^6.8.0+ | React Router v6 升级 |
| connected-react-router | 6.5.2 | 7.0.0+ | 兼容 React Router v6 |
| @types/react-redux | ^7.1.0 | ^8.1.0+ | 类型定义更新 |
| @types/react-router-dom | ^5.1.2 | ^5.3.0+ | 类型定义更新 |

#### 2.2 Redux 生态系统升级
| 包名 | 当前版本 | 目标版本 | 说明 |
|------|----------|----------|------|
| redux | ^4.0.1 | ^4.2.0+ | 性能优化和 bug 修复 |
| redux-saga | ^0.16.0 | ^1.2.0+ | 重要更新和 bug 修复 |

#### 2.3 工具链升级
| 包名 | 当前版本 | 目标版本 | 说明 |
|------|----------|----------|------|
| eslint | ^5.6.0 | ^8.0.0+ | 重大版本升级 |
| babel-eslint | ^9.0.0 | @babel/eslint-parser | 迁移到新的解析器 |
| prettier | ^1.14.3 | ^2.8.0+ | 代码格式化升级 |

### 阶段三: 测试框架升级 (预计 2 天)

#### 3.1 测试工具现代化
- **Jest**: 升级到最新版本
- **React Testing Library**: 升级到支持 React 18 的版本
- **测试覆盖率**: 确保升级后覆盖率不降低

#### 3.2 兼容性测试
- **React 版本测试**: 测试 React 16.14+ 到 React 18+ 的兼容性
- **浏览器测试**: 确保在主流浏览器中正常工作
- **Node.js 版本测试**: 验证在不同 Node.js 版本下的兼容性

### 阶段四: 构建工具和配置升级 (预计 1-2 天)

#### 4.1 ESLint 配置升级
- 迁移到 `@babel/eslint-parser`
- 更新 ESLint 规则以支持新语法
- 修复废弃的规则配置

#### 4.2 构建配置优化
- 更新 `father-build` 到最新版本
- 优化打包配置
- 确保 ESM 和 CommonJS 构建正常

### 阶段五: 文档和示例更新 (预计 1-2 天)

#### 5.1 文档更新
- 更新 README 中的依赖版本信息
- 添加 React 18 特性使用指南
- 更新 API 文档

#### 5.2 示例项目更新
- 更新 examples 目录中的示例项目
- 确保所有示例在 React 18+ 下正常运行
- 添加 React 18 新特性的示例

## 技术风险评估

### 高风险项
1. **React Router v6 升级**: API 有重大变更，需要仔细处理
2. **Connected React Router 升级**: 可能影响路由状态管理
3. **ESLint 重大版本升级**: 规则变更可能影响现有代码

### 中风险项
1. **React 18 并发特性**: 可能影响现有应用的行为
2. **Redux 升级**: 可能存在不兼容的变更

### 低风险项
1. **类型定义升级**: 主要是类型层面的更新
2. **文档更新**: 不影响代码功能

## 质量保证计划

### 测试策略
1. **单元测试**: 覆盖率保持在 90% 以上
2. **集成测试**: 验证各包之间的协作
3. **端到端测试**: 验证完整的应用场景
4. **性能测试**: 确保升级后性能不降低

### 兼容性测试
1. **向后兼容**: 确保现有 API 不变
2. **版本兼容**: 测试不同 React 版本的兼容性
3. **浏览器兼容**: 主流浏览器测试

## 发布计划

### 版本规划
- **v3.0.0-alpha.2**: React 18 新特性支持
- **v3.0.0-beta.1**: 依赖包升级完成
- **v3.0.0-rc.1**: 测试完成，稳定候选版本
- **v3.0.0**: 正式版本发布

### 发布检查清单
- [ ] 所有测试通过
- [ ] 文档更新完成
- [ ] 示例项目验证通过
- [ ] 性能测试通过
- [ ] 安全审查完成

## 资源需求

### 人力资源
- **前端开发工程师**: 1-2 人，负责核心升级工作
- **测试工程师**: 1 人，负责测试验证
- **文档工程师**: 0.5 人，负责文档更新

### 时间安排
- **总工期**: 10-14 个工作日
- **关键里程碑**: 
  - 第 5 天: React 18 新特性支持完成
  - 第 8 天: 依赖包升级完成
  - 第 12 天: 测试验证完成
  - 第 14 天: 发布准备完成

## 成功标准

### 功能标准
1. ✅ 所有现有 API 保持不变
2. ✅ 完全兼容 React 18+
3. ✅ 所有测试通过
4. ✅ 性能不低于升级前

### 质量标准
1. ✅ 代码覆盖率 ≥ 90%
2. ✅ 无严重安全漏洞
3. ✅ 文档完整准确
4. ✅ 示例项目可正常运行

## 后续维护计划

### 长期支持
- 持续跟进 React 新版本发布
- 定期更新依赖包
- 社区反馈及时响应

### 生态建设
- 更新最佳实践指南
- 提供迁移工具
- 社区培训和支持

---

**文档版本**: 1.0  
**创建时间**: 2026-01-18  
**负责人**: 开发团队  
**审核人**: 技术负责人
